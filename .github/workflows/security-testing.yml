name: Security Testing with OWASP

on:
  workflow_dispatch: # Manual trigger only to avoid duplicate CI runs
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]

env:
  NODE_VERSION: 18

jobs:
  security-tests:
    name: OWASP Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create .env file
        run: |
          echo "BASE_URL=https://portal-uat.ntdp-sa.com" >> .env
          echo "SAUDI_ID=1111111111" >> .env
          echo "EXPECTED_NAME=Dummy" >> .env
          echo "ZAP_BASE_URL=http://localhost:8080" >> .env
          echo "ZAP_API_KEY=" >> .env

      - name: Run basic security tests
        run: npm run test:security:basic
        env:
          CI: true
        continue-on-error: true

      - name: Run OWASP Top 10 tests
        run: npm run test:security:owasp
        env:
          CI: true
        continue-on-error: true

      - name: Run vulnerability tests
        run: npm run test:security:vulnerabilities
        env:
          CI: true
        continue-on-error: true

      - name: Upload security test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results
          path: |
            test-results/security/
            playwright-report/
          retention-days: 30

      - name: Upload security screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-screenshots
          path: test-results/security/*.png
          retention-days: 30

  # Optional: ZAP Full Scan (requires ZAP setup)
  zap-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: false # Disabled by default - enable when ZAP is configured

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start ZAP Daemon
        run: |
          docker run -d --name zap-daemon \
            -p 8080:8080 \
            -i owasp/zap2docker-stable zap.sh -daemon \
            -host 0.0.0.0 -port 8080 \
            -config api.addrs.addr.name=.* \
            -config api.addrs.addr.regex=true

      - name: Wait for ZAP to start
        run: |
          timeout 300 bash -c 'until curl -s http://localhost:8080/JSON/core/view/version/ > /dev/null; do sleep 5; done'

      - name: Create .env file
        run: |
          echo "BASE_URL=https://portal-uat.ntdp-sa.com" >> .env
          echo "SAUDI_ID=1111111111" >> .env
          echo "EXPECTED_NAME=Dummy" >> .env
          echo "ZAP_BASE_URL=http://localhost:8080" >> .env
          echo "ZAP_API_KEY=" >> .env

      - name: Run ZAP integrated security tests
        run: npx playwright test tests/security.spec.ts --grep "ZAP scan"
        env:
          CI: true
        continue-on-error: true

      - name: Generate ZAP HTML Report
        run: |
          curl "http://localhost:8080/OTHER/core/other/htmlreport/" > zap-report.html

      - name: Upload ZAP results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-results
          path: |
            zap-report.html
            test-results/security/
          retention-days: 30

      - name: Stop ZAP daemon
        if: always()
        run: docker stop zap-daemon || true

  security-summary:
    name: Security Test Summary
    runs-on: ubuntu-latest
    needs: [security-tests]
    if: always()

    steps:
      - name: Download security artifacts
        uses: actions/download-artifact@v4
        with:
          name: security-test-results
          path: security-results/

      - name: Security Summary
        run: |
          echo "## ðŸ”’ Security Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security tests have been completed for this build." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Basic Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OWASP Top 10 Testing" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Common Vulnerability Testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "- Security scan reports in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots of security tests" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed HTML reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ Note:** Review security reports in the artifacts section for detailed findings." >> $GITHUB_STEP_SUMMARY
