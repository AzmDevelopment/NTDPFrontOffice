name: OWASP ZAP Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  zap-scan:
    name: ZAP Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start OWASP ZAP
        run: |
          docker run -d \
            --name zap-proxy \
            -p 8080:8080 \
            -e ZAP_API_KEY=changeme \
            owasp/zap2docker-stable \
            zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.key=changeme

          echo "â³ Waiting for ZAP to start..."
          sleep 30

          # Verify ZAP is running
          curl -s http://localhost:8080 || echo "ZAP may not be ready yet"

          # Wait a bit more to ensure ZAP is fully ready
          sleep 10

      - name: Run Playwright Tests with ZAP Proxy
        env:
          USE_ZAP: "true"
          ZAP_API_KEY: changeme
          ZAP_PROXY: http://localhost:8080
          SAUDI_ID: ${{ secrets.SAUDI_ID }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: npm test
        continue-on-error: true

      - name: Upload ZAP Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-reports-${{ github.run_number }}
          path: test-results/zap-reports/
          retention-days: 30

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-playwright-report-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: Generate Security Summary
        if: always()
        run: |
          echo "## ðŸ”’ OWASP ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Type**: Passive scan via proxy during test execution" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if reports exist
          if [ -d "test-results/zap-reports" ] && [ "$(ls -A test-results/zap-reports 2>/dev/null)" ]; then
            echo "âœ… **Status**: Scan completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Try to extract summary from JSON report
            JSON_FILE=$(ls -t test-results/zap-reports/*.json 2>/dev/null | head -1)
            if [ -f "$JSON_FILE" ]; then
              echo "### ðŸ“Š Security Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              HIGH=$(grep -oP '"high":\s*\K\d+' "$JSON_FILE" || echo "0")
              MEDIUM=$(grep -oP '"medium":\s*\K\d+' "$JSON_FILE" || echo "0")
              LOW=$(grep -oP '"low":\s*\K\d+' "$JSON_FILE" || echo "0")
              INFO=$(grep -oP '"informational":\s*\K\d+' "$JSON_FILE" || echo "0")
              TOTAL=$(grep -oP '"total":\s*\K\d+' "$JSON_FILE" || echo "0")
              
              echo "| Risk Level | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| ðŸ”´ High | $HIGH |" >> $GITHUB_STEP_SUMMARY
              echo "| ðŸŸ  Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
              echo "| ðŸŸ¡ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
              echo "| â„¹ï¸ Info | $INFO |" >> $GITHUB_STEP_SUMMARY
              echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### ðŸ“„ Reports Generated" >> $GITHUB_STEP_SUMMARY
            echo "- HTML Reports" >> $GITHUB_STEP_SUMMARY
            echo "- Markdown Reports" >> $GITHUB_STEP_SUMMARY
            echo "- JSON Reports" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the **Artifacts** section above to download reports." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Status**: No reports generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ZAP may not have detected any traffic or reports were not created." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stop ZAP
        if: always()
        run: |
          echo "ðŸ›‘ Stopping ZAP container..."
          docker stop zap-proxy || true
          docker rm zap-proxy || true
